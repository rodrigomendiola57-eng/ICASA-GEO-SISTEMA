{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ category.name }} - Manual de Organizaci칩n{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header de Categor칤a -->
    <div class="bg-white border-b border-gray-200 shadow-sm">
        <div class="px-6 py-4">
            <!-- Breadcrumb -->
            <nav class="flex mb-4" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-3">
                    <li class="inline-flex items-center">
                        <a href="{% url 'knowledge_base:dashboard' %}" class="text-gray-700 hover:text-blue-600">
                            <i class="fas fa-home mr-2"></i>Manual
                        </a>
                    </li>
                    {% for ancestor in category.get_ancestors %}
                        <li>
                            <div class="flex items-center">
                                <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                                <a href="{% url 'knowledge_base:category_detail' ancestor.slug %}" class="text-gray-700 hover:text-blue-600">
                                    {{ ancestor.name }}
                                </a>
                            </div>
                        </li>
                    {% endfor %}
                    <li>
                        <div class="flex items-center">
                            <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                            <span class="text-gray-500">{{ category.name }}</span>
                        </div>
                    </li>
                </ol>
            </nav>
            
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-16 h-16 rounded-lg flex items-center justify-center mr-4" 
                         style="background-color: {{ category.color }}20; color: {{ category.color }};">
                        <i class="{{ category.icon|default:'fas fa-folder' }} text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">{{ category.name }}</h1>
                        <p class="text-gray-600 mt-1">{{ category.description }}</p>
                        <div class="flex items-center space-x-4 mt-2 text-sm text-gray-500">
                            <span><i class="fas fa-file-alt mr-1"></i>{{ documents.count }} documentos</span>
                            <span><i class="fas fa-folder mr-1"></i>{{ subcategories.count }} subcategor칤as</span>
                            <span><i class="fas fa-clock mr-1"></i>Actualizado {{ category.updated_at|date:"d/m/Y" }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    {% if perms.knowledge_base.add_document %}
                        <a href="{% url 'knowledge_base:document_create' %}?category={{ category.slug }}" 
                           class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Nuevo Documento
                        </a>
                    {% endif %}
                    
                    {% if perms.knowledge_base.add_category %}
                        <button onclick="createSubcategory()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-folder-plus mr-2"></i>Subcategor칤a
                        </button>
                    {% endif %}
                    
                    <a href="{% url 'knowledge_base:categories_management' %}" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        <i class="fas fa-sitemap mr-2"></i>Gestionar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="p-6">
        <!-- Subcategor칤as -->
        {% if subcategories %}
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-folder-open text-blue-600 mr-2"></i>
                    Subcategor칤as ({{ subcategories.count }})
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for subcategory in subcategories %}
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow cursor-pointer"
                             onclick="window.location.href='{% url 'knowledge_base:category_detail' subcategory.slug %}'">
                            <div class="p-4">
                                <div class="flex items-center mb-3">
                                    <div class="w-10 h-10 rounded-lg flex items-center justify-center mr-3" 
                                         style="background-color: {{ subcategory.color }}20; color: {{ subcategory.color }};">
                                        <i class="{{ subcategory.icon|default:'fas fa-folder' }}"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="font-semibold text-gray-900">{{ subcategory.name }}</h3>
                                        <p class="text-sm text-gray-600">{{ subcategory.get_document_count }} documentos</p>
                                    </div>
                                </div>
                                
                                {% if subcategory.description %}
                                    <p class="text-sm text-gray-700 mb-3">{{ subcategory.description|truncatewords:15 }}</p>
                                {% endif %}
                                
                                <div class="flex items-center justify-between text-xs text-gray-500">
                                    <span>{{ subcategory.updated_at|date:"d/m/Y" }}</span>
                                    <i class="fas fa-arrow-right"></i>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- Documentos -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-file-alt text-green-600 mr-2"></i>
                        Documentos ({{ documents.count }})
                    </h2>
                    
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <input type="text" id="searchDocs" placeholder="Buscar documentos..." 
                                   class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        
                        <select id="filterStatus" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Todos los estados</option>
                            <option value="draft">Borrador</option>
                            <option value="review">En Revisi칩n</option>
                            <option value="approved">Aprobado</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                {% if documents %}
                    <div class="space-y-4" id="documentsList">
                        {% for document in documents %}
                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer document-item"
                                 data-status="{{ document.status }}"
                                 onclick="window.location.href='{% url 'knowledge_base:document_detail' document.slug %}'">
                                <div class="flex items-center flex-1">
                                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-file-alt text-green-600"></i>
                                    </div>
                                    
                                    <div class="flex-1">
                                        <h3 class="font-semibold text-gray-900 mb-1">{{ document.title }}</h3>
                                        <div class="flex items-center space-x-4 text-sm text-gray-600">
                                            <span><i class="fas fa-code mr-1"></i>{{ document.document_code }}</span>
                                            <span><i class="fas fa-user mr-1"></i>{{ document.created_by.get_full_name|default:document.created_by.username }}</span>
                                            <span><i class="fas fa-calendar mr-1"></i>{{ document.updated_at|date:"d/m/Y" }}</span>
                                        </div>
                                        
                                        {% if document.summary %}
                                            <p class="text-sm text-gray-700 mt-2">{{ document.summary|truncatewords:20 }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="flex items-center space-x-3">
                                    <span class="px-3 py-1 text-xs rounded-full
                                        {% if document.status == 'approved' %}bg-green-100 text-green-800
                                        {% elif document.status == 'review' %}bg-yellow-100 text-yellow-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ document.get_status_display }}
                                    </span>
                                    
                                    {% if document.tags.all %}
                                        <div class="flex items-center space-x-1">
                                            {% for tag in document.tags.all|slice:":2" %}
                                                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">{{ tag.name }}</span>
                                            {% endfor %}
                                            {% if document.tags.count > 2 %}
                                                <span class="text-xs text-gray-500">+{{ document.tags.count|add:"-2" }}</span>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    
                                    <i class="fas fa-arrow-right text-gray-400"></i>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Paginaci칩n si es necesaria -->
                    {% if documents.count > 20 %}
                        <div class="mt-6 flex justify-center">
                            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Cargar m치s documentos
                            </button>
                        </div>
                    {% endif %}
                {% else %}
                    <!-- Estado vac칤o -->
                    <div class="text-center py-12">
                        <i class="fas fa-file-alt text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">No hay documentos</h3>
                        <p class="text-gray-600 mb-6">Esta categor칤a a칰n no tiene documentos. Comienza creando el primero.</p>
                        
                        {% if perms.knowledge_base.add_document %}
                            <a href="{% url 'knowledge_base:document_create' %}?category={{ category.slug }}" 
                               class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-plus mr-2"></i>Crear Primer Documento
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// B칰squeda en tiempo real
document.getElementById('searchDocs').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    const documents = document.querySelectorAll('.document-item');
    
    documents.forEach(doc => {
        const title = doc.querySelector('h3').textContent.toLowerCase();
        const visible = title.includes(query);
        doc.style.display = visible ? 'flex' : 'none';
    });
});

// Filtro por estado
document.getElementById('filterStatus').addEventListener('change', function(e) {
    const status = e.target.value;
    const documents = document.querySelectorAll('.document-item');
    
    documents.forEach(doc => {
        const docStatus = doc.getAttribute('data-status');
        const visible = !status || docStatus === status;
        doc.style.display = visible ? 'flex' : 'none';
    });
});

// Crear subcategor칤a
function createSubcategory() {
    alert('游뚾 Funci칩n de crear subcategor칤a en desarrollo');
}
</script>
{% endblock %}
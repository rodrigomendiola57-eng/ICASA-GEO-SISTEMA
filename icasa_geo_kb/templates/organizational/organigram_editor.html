{% extends 'base/base.html' %}
{% load static %}

{% block title %}Editor - {{ chart.name }} - ICASA-GEO{% endblock %}

{% block content %}
<div class="h-screen flex flex-col bg-gray-100">
    <!-- Header del Editor -->
    <div class="bg-white border-b border-gray-200 p-4 flex-shrink-0">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="{% url 'organizational:departmental_chart_detail' chart.id %}" 
                   class="text-gray-500 hover:text-green-600 transition-colors">
                    <i class="fas fa-arrow-left text-lg"></i>
                </a>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">Editor de Organigrama</h1>
                    <p class="text-sm text-gray-600">{{ chart.name }} - {{ chart.department }}</p>
                </div>
            </div>
            
            <!-- Controles del Editor -->
            <div class="flex items-center space-x-2">
                <button onclick="showCreationWizard()" 
                        class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                    <i class="fas fa-magic mr-1"></i>Asistente
                </button>
                <button onclick="autoLayout()" 
                        class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm">
                    <i class="fas fa-sitemap mr-1"></i>Auto Layout
                </button>
                <button onclick="centerChart()" 
                        class="px-3 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors text-sm">
                    <i class="fas fa-crosshairs mr-1"></i>Centrar
                </button>

                <button onclick="stepBack()" id="stepBackBtn" disabled
                        class="px-3 py-2 bg-gray-400 text-white rounded-lg transition-colors text-sm">
                    <i class="fas fa-arrow-left mr-1"></i>Atrás
                </button>
                <button onclick="stepForward()" id="stepForwardBtn" disabled
                        class="px-3 py-2 bg-gray-400 text-white rounded-lg transition-colors text-sm">
                    <i class="fas fa-arrow-right mr-1"></i>Adelante
                </button>
                <button onclick="clearAll()" 
                        class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
                    <i class="fas fa-trash mr-1"></i>Deshacer Todo
                </button>
                <div class="border-l border-gray-300 h-8 mx-2"></div>
                <button onclick="saveChart()" 
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-save mr-2"></i>Guardar
                </button>
                <div class="relative">
                    <button onclick="toggleExportMenu()" 
                            class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                        <i class="fas fa-download mr-1"></i>Exportar <i class="fas fa-chevron-down ml-1 text-xs"></i>
                    </button>
                    <div id="exportMenu" class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-10">
                        <button onclick="exportToPNG()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">
                            <i class="fas fa-image mr-2 text-green-600"></i>Exportar como PNG
                        </button>
                        <button onclick="exportToPDF()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">
                            <i class="fas fa-file-pdf mr-2 text-red-600"></i>Exportar como PDF
                        </button>
                        <button onclick="exportToSVG()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">
                            <i class="fas fa-vector-square mr-2 text-purple-600"></i>Exportar como SVG
                        </button>
                        <hr class="my-1">
                        <button onclick="printChart()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">
                            <i class="fas fa-print mr-2 text-gray-600"></i>Imprimir
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Toolbar -->
        <div class="mt-3 flex items-center space-x-4 text-sm">
            <div class="flex items-center space-x-2">
                <label class="font-medium text-gray-700">Zoom:</label>
                <button onclick="zoomOut()" class="p-1 text-gray-600 hover:text-gray-800">
                    <i class="fas fa-minus"></i>
                </button>
                <span id="zoomLevel" class="px-2 py-1 bg-gray-100 rounded text-xs">100%</span>
                <button onclick="zoomIn()" class="p-1 text-gray-600 hover:text-gray-800">
                    <i class="fas fa-plus"></i>
                </button>
                <button onclick="resetZoom()" class="px-2 py-1 text-gray-600 hover:text-gray-800 text-xs">
                    Reset
                </button>
            </div>
            
            <div class="flex items-center space-x-2">
                <label class="font-medium text-gray-700">Modo:</label>
                <select id="editorMode" onchange="changeMode()" class="px-2 py-1 border border-gray-300 rounded text-xs">
                    <option value="select">Seleccionar</option>
                    <option value="pan">Navegar (Mano)</option>
                    <option value="connect">Conectar</option>
                    <option value="add">Agregar Posición</option>
                    <option value="multi">Selección Múltiple</option>
                </select>
            </div>
            
            <div class="flex items-center space-x-2">
                <label class="font-medium text-gray-700">Vista:</label>
                <select id="viewMode" onchange="changeViewMode()" class="px-2 py-1 border border-gray-300 rounded text-xs">
                    <option value="normal">Normal</option>
                    <option value="compact">Compacta</option>
                    <option value="detailed">Detallada</option>
                </select>
            </div>
            
            <div class="flex items-center space-x-2">
                <button onclick="toggleGrid()" id="gridToggle" 
                        class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs hover:bg-gray-300">
                    <i class="fas fa-th mr-1"></i>Grid
                </button>
                <button onclick="toggleSnap()" id="snapToggle" 
                        class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs hover:bg-gray-300">
                    <i class="fas fa-magnet mr-1"></i>Snap
                </button>
            </div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Panel Lateral Izquierdo -->
        <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
            <!-- Pestañas -->
            <div class="flex border-b border-gray-200">
                <button onclick="showTab('positions')" id="positionsTab" 
                        class="flex-1 px-4 py-3 text-sm font-medium text-center border-b-2 border-green-500 text-green-600">
                    Posiciones
                </button>
                <button onclick="showTab('properties')" id="propertiesTab" 
                        class="flex-1 px-4 py-3 text-sm font-medium text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    Propiedades
                </button>
            </div>
            
            <!-- Panel de Posiciones -->
            <div id="positionsPanel" class="flex-1 overflow-auto p-4">
                <!-- Información de Jerarquía ICASA -->
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <h4 class="text-sm font-semibold text-blue-800 mb-2">Jerarquía ICASA</h4>
                    <div class="text-xs text-blue-700 space-y-1">
                        <div class="flex justify-between"><span>Nivel 1:</span><span>Director General</span></div>
                        <div class="flex justify-between"><span>Nivel 2:</span><span>Directores</span></div>
                        <div class="flex justify-between"><span>Nivel 3:</span><span>Gerentes</span></div>
                        <div class="flex justify-between"><span>Nivel 4:</span><span>Jefes</span></div>
                        <div class="flex justify-between"><span>Nivel 5:</span><span>Operadores</span></div>
                        <div class="flex justify-between"><span>Nivel 6:</span><span>Auxiliares</span></div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <input type="text" id="positionSearch" placeholder="Buscar posición..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                           onkeyup="filterPositions()">
                </div>
                
                <div class="mb-4">
                    <select id="departmentFilter" onchange="filterPositions()" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <option value="">Todos los departamentos</option>
                        {% for dept in departments %}
                            <option value="{{ dept }}">{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="space-y-2" id="positionsList">
                    {% for position in all_positions %}
                        <div class="position-item p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors"
                             data-position-id="{{ position.id }}"
                             data-department="{{ position.department }}"
                             data-title="{{ position.title|lower }}"
                             data-level="{{ position.level }}"
                             onclick="addPositionToChart({{ position.id }})">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2">
                                        <span class="inline-flex items-center justify-center w-6 h-6 text-xs font-bold text-white rounded-full
                                            {% if position.level == 1 %}bg-purple-600
                                            {% elif position.level == 2 %}bg-blue-600
                                            {% elif position.level == 3 %}bg-green-600
                                            {% elif position.level == 4 %}bg-yellow-600
                                            {% elif position.level == 5 %}bg-orange-600
                                            {% else %}bg-gray-600{% endif %}">
                                            {{ position.level }}
                                        </span>
                                        <div>
                                            <h4 class="font-medium text-gray-900 text-sm">{{ position.title }}</h4>
                                            <p class="text-xs text-gray-600">{{ position.department }}</p>
                                            {% if position.get_current_employee %}
                                                <p class="text-xs text-green-700">{{ position.get_current_employee.first_name }} {{ position.get_current_employee.last_name }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    {% if position.is_vacant %}
                                        <span class="inline-block w-2 h-2 bg-red-500 rounded-full" title="Vacante"></span>
                                    {% else %}
                                        <span class="inline-block w-2 h-2 bg-green-500 rounded-full" title="Ocupado"></span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Panel de Propiedades -->
            <div id="propertiesPanel" class="flex-1 overflow-auto p-4 hidden">
                <div id="noSelection" class="text-center text-gray-500 mt-8">
                    <i class="fas fa-mouse-pointer text-3xl mb-2"></i>
                    <p class="text-sm">Selecciona una posición para ver sus propiedades</p>
                </div>
                
                <div id="positionProperties" class="hidden">
                    <h3 class="font-semibold text-gray-900 mb-3">Propiedades de la Posición</h3>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                            <input type="text" id="propTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" readonly>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Departamento</label>
                            <input type="text" id="propDepartment" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" readonly>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">X</label>
                                <input type="number" id="propX" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" 
                                       onchange="updatePositionCoords()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Y</label>
                                <input type="number" id="propY" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" 
                                       onchange="updatePositionCoords()">
                            </div>
                        </div>
                        
                        <div class="pt-3 border-t border-gray-200">
                            <button onclick="removeSelectedPosition()" 
                                    class="w-full px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
                                <i class="fas fa-trash mr-2"></i>Remover del Organigrama
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área de Trabajo (Canvas) -->
        <div class="flex-1 relative overflow-auto bg-white">
            <!-- Grid de fondo cuadriculado -->
            <div id="gridBackground" class="absolute pointer-events-none"
                 style="width: 3000px; height: 2000px;
                 background-image: 
                    linear-gradient(to right, #e5e7eb 1px, transparent 1px),
                    linear-gradient(to bottom, #e5e7eb 1px, transparent 1px);
                 background-size: 25px 25px;"></div>
            
            <!-- Grid mayor cada 100px -->
            <div id="majorGrid" class="absolute pointer-events-none"
                 style="width: 3000px; height: 2000px;
                 background-image: 
                    linear-gradient(to right, #d1d5db 1px, transparent 1px),
                    linear-gradient(to bottom, #d1d5db 1px, transparent 1px);
                 background-size: 100px 100px;"></div>
            
            <!-- Canvas SVG -->
            <svg id="organigramCanvas" class="cursor-crosshair" width="3000" height="2000">
                <defs>
                    <!-- Marcadores para las flechas -->
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                            refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
                    </marker>
                    
                    <!-- Filtros para sombras -->
                    <filter id="dropshadow" x="-20%" y="-20%" width="140%" height="140%">
                        <feDropShadow dx="2" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.3"/>
                    </filter>
                </defs>
                
                <!-- Grupo para conexiones -->
                <g id="connectionsGroup"></g>
                
                <!-- Grupo para posiciones -->
                <g id="positionsGroup"></g>
            </svg>
            
            <!-- Controles de Zoom fijos -->
            <div class="fixed bottom-4 right-4 bg-white border border-gray-300 rounded-lg shadow-lg p-2 z-20">
                <div class="flex flex-col space-y-1">
                    <button onclick="zoomIn()" class="w-12 h-10 bg-blue-50 border border-blue-200 rounded hover:bg-blue-100 flex items-center justify-center transition-colors">
                        <span class="text-blue-600 font-bold text-lg">+</span>
                    </button>
                    <div class="text-center py-1">
                        <span id="zoomDisplay" class="text-xs font-medium text-gray-700">100%</span>
                    </div>
                    <button onclick="zoomOut()" class="w-12 h-10 bg-blue-50 border border-blue-200 rounded hover:bg-blue-100 flex items-center justify-center transition-colors">
                        <span class="text-blue-600 font-bold text-lg">-</span>
                    </button>
                    <div class="border-t border-gray-200 pt-1 mt-1">
                        <button onclick="resetZoom()" class="w-12 h-8 bg-gray-50 border border-gray-200 rounded hover:bg-gray-100 flex items-center justify-center transition-colors" title="Ajustar a pantalla">
                            <i class="fas fa-expand-arrows-alt text-gray-600 text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status Bar -->
    <div class="bg-white border-t border-gray-200 px-4 py-2 flex items-center justify-between text-sm text-gray-600">
        <div class="flex items-center space-x-4">
            <span id="statusMessage">Listo</span>
            <span>|</span>
            <span id="positionCount">0 posiciones</span>
            <span>|</span>
            <span id="connectionCount">0 conexiones</span>
        </div>
        <div class="flex items-center space-x-2">
            <span id="mouseCoords">x: 0, y: 0</span>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg p-6 text-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto mb-4"></div>
        <p class="text-gray-700">Guardando organigrama...</p>
    </div>
</div>

<!-- Asistente Simple -->
<div id="creationWizard" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4">
        <div class="p-6">
            <h2 class="text-xl font-bold mb-4">Crear Organigrama</h2>
            <p class="text-gray-600 mb-6">Selecciona las posiciones que quieres agregar:</p>
            
            <div class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-2 mb-4">
                {% for position in all_positions %}
                    <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox" class="mr-3" value="{{ position.id }}" onchange="updateSelectedCount()">
                        <div>
                            <div class="font-medium text-sm">{{ position.title }}</div>
                            <div class="text-xs text-gray-600">{{ position.department }}</div>
                        </div>
                    </label>
                {% endfor %}
            </div>
            
            <div class="text-sm text-gray-600 mb-4">
                <span id="selectedCount">0</span> posiciones seleccionadas
            </div>
            
            <div class="flex justify-end space-x-2">
                <button onclick="closeCreationWizard()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                    Cancelar
                </button>
                <button onclick="createSimpleOrganigram()" id="createBtn" disabled
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400">
                    Crear
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales del asistente (simplificado)

// Variables globales del editor
let currentZoom = 1;
let isDragging = false;
let dragOffset = { x: 0, y: 0 };
let selectedPosition = null;
let selectedPositions = []; // Para selección múltiple
let editorMode = 'select';
let viewMode = 'normal';
let gridEnabled = false;
let snapEnabled = false;
let positions = [];
let connections = [];
let connectionStart = null;
let historyStack = [];
let currentHistoryIndex = -1;
let maxHistorySteps = 20;
let isPanning = false;
let panStart = { x: 0, y: 0 };
let canvasContainer = null;

// Inicializar editor
document.addEventListener('DOMContentLoaded', function() {
    loadChartData();
    setupEventListeners();
    updateStatusBar();
    
    // Activar grid por defecto
    gridEnabled = true;
    const button = document.getElementById('gridToggle');
    button.classList.add('bg-green-200', 'text-green-800');
    button.classList.remove('bg-gray-200', 'text-gray-700');
    
    // Inicializar historial
    if (positions.length > 0) {
        setTimeout(() => saveState(), 100);
    }
});

// Cargar datos del organigrama
function loadChartData() {
    showStatus('Cargando organigrama...');
    
    fetch(`/organizational/api/departmental/{{ chart.id }}/positions/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                positions = data.positions || [];
                connections = data.connections || [];
                
                // Si no hay posiciones, mostrar asistente de creación
                if (positions.length === 0) {
                    showCreationWizard();
                } else {
                    renderChart();
                    saveState();
                }
                
                showStatus('Organigrama cargado');
            } else {
                showStatus('Error al cargar organigrama');
                console.error('Error:', data.error);
            }
        })
        .catch(error => {
            showStatus('Error de conexión');
            console.error('Error:', error);
        });
}

// Renderizar organigrama
function renderChart() {
    const positionsGroup = document.getElementById('positionsGroup');
    const connectionsGroup = document.getElementById('connectionsGroup');
    
    // Limpiar canvas
    positionsGroup.innerHTML = '';
    connectionsGroup.innerHTML = '';
    
    // Renderizar conexiones primero (para que estén detrás)
    connections.forEach(connection => {
        renderConnection(connection);
    });
    
    // Renderizar posiciones
    positions.forEach(position => {
        renderPosition(position);
    });
    
    updateStatusBar();
}

// Renderizar posición individual
function renderPosition(position) {
    const positionsGroup = document.getElementById('positionsGroup');
    
    // Crear grupo para la posición
    const positionGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    positionGroup.setAttribute('class', 'position-node');
    positionGroup.setAttribute('data-position-id', position.id);
    positionGroup.setAttribute('transform', `translate(${position.x}, ${position.y})`);
    positionGroup.style.cursor = 'pointer';
    
    // Rectángulo de fondo
    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute('width', '180');
    rect.setAttribute('height', '80');
    rect.setAttribute('rx', '8');
    rect.setAttribute('fill', position.is_vacant ? '#fee2e2' : '#f0f9ff');
    rect.setAttribute('stroke', position.is_vacant ? '#dc2626' : '#0369a1');
    rect.setAttribute('stroke-width', '2');
    rect.setAttribute('filter', 'url(#dropshadow)');
    
    // Título de la posición
    const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    title.setAttribute('x', '90');
    title.setAttribute('y', '20');
    title.setAttribute('text-anchor', 'middle');
    title.setAttribute('font-family', 'Arial, sans-serif');
    title.setAttribute('font-size', '12');
    title.setAttribute('font-weight', 'bold');
    title.setAttribute('fill', '#1f2937');
    title.textContent = position.title.length > 20 ? position.title.substring(0, 20) + '...' : position.title;
    
    // Departamento
    const dept = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    dept.setAttribute('x', '90');
    dept.setAttribute('y', '35');
    dept.setAttribute('text-anchor', 'middle');
    dept.setAttribute('font-family', 'Arial, sans-serif');
    dept.setAttribute('font-size', '10');
    dept.setAttribute('fill', '#6b7280');
    dept.textContent = position.department;
    
    // Empleado o "Vacante"
    const employee = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    employee.setAttribute('x', '90');
    employee.setAttribute('y', '55');
    employee.setAttribute('text-anchor', 'middle');
    employee.setAttribute('font-family', 'Arial, sans-serif');
    employee.setAttribute('font-size', '10');
    employee.setAttribute('fill', position.is_vacant ? '#dc2626' : '#059669');
    employee.textContent = position.employee ? position.employee.name : 'VACANTE';
    
    // ID del empleado (si existe)
    if (position.employee && position.employee.employee_id) {
        const empId = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        empId.setAttribute('x', '90');
        empId.setAttribute('y', '70');
        empId.setAttribute('text-anchor', 'middle');
        empId.setAttribute('font-family', 'Arial, sans-serif');
        empId.setAttribute('font-size', '9');
        empId.setAttribute('fill', '#9ca3af');
        empId.textContent = `ID: ${position.employee.employee_id}`;
        positionGroup.appendChild(empId);
    }
    
    // Agregar elementos al grupo
    positionGroup.appendChild(rect);
    positionGroup.appendChild(title);
    positionGroup.appendChild(dept);
    positionGroup.appendChild(employee);
    
    // Event listeners
    positionGroup.addEventListener('mousedown', (e) => {
        if (editorMode === 'select' || editorMode === 'multi') {
            startDrag(e, position);
        }
    });
    
    positionGroup.addEventListener('click', (e) => {
        e.stopPropagation();
        
        if (editorMode === 'connect') {
            handleConnectionClick(position);
        } else if (editorMode === 'multi') {
            const multiSelect = e.ctrlKey || e.metaKey;
            selectPosition(position, multiSelect);
        } else if (editorMode === 'select') {
            selectPosition(position);
        }
    });
    
    positionsGroup.appendChild(positionGroup);
}

// Renderizar conexión jerárquica precisa
function renderConnection(connection) {
    const connectionsGroup = document.getElementById('connectionsGroup');
    
    const fromPos = positions.find(p => p.id === connection.from);
    const toPos = positions.find(p => p.id === connection.to);
    
    if (!fromPos || !toPos) return;
    
    // Calcular puntos de conexión precisos según modo de vista
    let boxWidth = 180, boxHeight = 80;
    switch(viewMode) {
        case 'compact': boxWidth = 140; boxHeight = 60; break;
        case 'detailed': boxWidth = 220; boxHeight = 100; break;
    }
    
    const fromX = fromPos.x + boxWidth/2; // Centro horizontal de la caja superior
    const fromY = fromPos.y + boxHeight;  // Parte inferior de la caja superior
    const toX = toPos.x + boxWidth/2;     // Centro horizontal de la caja inferior
    const toY = toPos.y;                  // Parte superior de la caja inferior
    
    // Crear path con líneas ortogonales para evitar entrelazado
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    
    // Calcular punto medio vertical para conexión limpia
    const midY = fromY + (toY - fromY) / 2;
    
    let pathData;
    if (Math.abs(fromX - toX) < 10) {
        // Conexión directa vertical (mismo eje X)
        pathData = `M ${fromX} ${fromY} L ${toX} ${toY}`;
    } else {
        // Conexión en L para evitar cruces
        pathData = `M ${fromX} ${fromY} L ${fromX} ${midY} L ${toX} ${midY} L ${toX} ${toY}`;
    }
    
    path.setAttribute('d', pathData);
    path.setAttribute('stroke', '#4f46e5');
    path.setAttribute('stroke-width', '2');
    path.setAttribute('fill', 'none');
    path.setAttribute('marker-end', 'url(#arrowhead)');
    path.setAttribute('class', 'hierarchy-connection');
    
    connectionsGroup.appendChild(path);
}

// Configurar event listeners
function setupEventListeners() {
    const canvas = document.getElementById('organigramCanvas');
    canvasContainer = canvas.parentElement;
    
    // Mouse tracking para coordenadas
    canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = Math.round((e.clientX - rect.left) / currentZoom);
        const y = Math.round((e.clientY - rect.top) / currentZoom);
        document.getElementById('mouseCoords').textContent = `x: ${x}, y: ${y}`;
        
        if (isPanning) {
            handlePanMove(e);
        } else if (isDragging && selectedPosition) {
            updatePositionPosition(e);
        }
    });
    
    // Click en canvas vacío
    canvas.addEventListener('click', (e) => {
        if (e.target === canvas && editorMode === 'add') {
            addPositionAtLocation(e);
        } else if (e.target === canvas && editorMode !== 'pan') {
            selectPosition(null);
            if (editorMode === 'connect') {
                connectionStart = null;
                showStatus('Conexión cancelada');
            }
        }
    });
    
    // Pan mode event listeners
    canvas.addEventListener('mousedown', (e) => {
        if (editorMode === 'pan') {
            isPanning = true;
            panStart.x = e.clientX;
            panStart.y = e.clientY;
            canvas.style.cursor = 'grabbing';
            e.preventDefault();
        }
    });
    
    document.addEventListener('mouseup', () => {
        if (isPanning) {
            isPanning = false;
            if (editorMode === 'pan') {
                canvas.style.cursor = 'grab';
            }
        }
    });
    
    // Cerrar menús al hacer click fuera
    document.addEventListener('click', (e) => {
        const exportMenu = document.getElementById('exportMenu');
        if (!e.target.closest('.relative') && !exportMenu.classList.contains('hidden')) {
            exportMenu.classList.add('hidden');
        }
    });
    
    // Wheel zoom
    canvas.addEventListener('wheel', (e) => {
        if (e.ctrlKey) {
            e.preventDefault();
            if (e.deltaY < 0) {
                zoomIn();
            } else {
                zoomOut();
            }
        }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Delete' && selectedPositions.length > 0) {
            if (selectedPositions.length === 1) {
                removeSelectedPosition();
            } else {
                removeMultiplePositions();
            }
        } else if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            saveChart();
        } else if (e.ctrlKey && e.key === 'z') {
            e.preventDefault();
            stepBack();
        } else if (e.ctrlKey && e.key === 'y') {
            e.preventDefault();
            stepForward();
        } else if (e.ctrlKey && e.key === 'a') {
            e.preventDefault();
            selectAllPositions();
        } else if (e.key === 'Escape') {
            selectPosition(null);
            editorMode = 'select';
            document.getElementById('editorMode').value = 'select';
            // Cerrar menús
            document.getElementById('exportMenu').classList.add('hidden');
        }
    });
}

// Funciones de interacción
function startDrag(e, position) {
    if (editorMode !== 'select' && editorMode !== 'multi') return;
    
    e.preventDefault();
    isDragging = true;
    selectedPosition = position;
    
    const rect = e.target.getBoundingClientRect();
    dragOffset.x = e.clientX - position.x;
    dragOffset.y = e.clientY - position.y;
    
    document.addEventListener('mousemove', updatePositionPosition);
    document.addEventListener('mouseup', stopDrag);
}

function updatePositionPosition(e) {
    if (!isDragging || !selectedPosition) return;
    
    const canvas = document.getElementById('organigramCanvas');
    const rect = canvas.getBoundingClientRect();
    
    let newX = (e.clientX - rect.left) / currentZoom - 90; // Centrar
    let newY = (e.clientY - rect.top) / currentZoom - 40;
    
    // Snap to grid si está habilitado (cuadrícula de 25px)
    if (snapEnabled) {
        newX = Math.round(newX / 25) * 25;
        newY = Math.round(newY / 25) * 25;
    }
    
    // Actualizar posición en el array
    const posIndex = positions.findIndex(p => p.id === selectedPosition.id);
    if (posIndex !== -1) {
        positions[posIndex].x = newX;
        positions[posIndex].y = newY;
        selectedPosition.x = newX;
        selectedPosition.y = newY;
    }
    
    // Re-renderizar
    renderChart();
    
    // Actualizar propiedades si están visibles
    if (!document.getElementById('positionProperties').classList.contains('hidden')) {
        document.getElementById('propX').value = Math.round(newX);
        document.getElementById('propY').value = Math.round(newY);
    }
}

function stopDrag() {
    isDragging = false;
    document.removeEventListener('mousemove', updatePositionPosition);
    document.removeEventListener('mouseup', stopDrag);
}

function selectPosition(position, multiSelect = false) {
    if (multiSelect && editorMode === 'multi') {
        if (position) {
            const index = selectedPositions.findIndex(p => p.id === position.id);
            if (index === -1) {
                selectedPositions.push(position);
            } else {
                selectedPositions.splice(index, 1);
            }
        }
        selectedPosition = selectedPositions.length > 0 ? selectedPositions[0] : null;
    } else {
        selectedPosition = position;
        selectedPositions = position ? [position] : [];
    }
    
    // Actualizar visual selection
    document.querySelectorAll('.position-node').forEach(node => {
        const nodeId = parseInt(node.getAttribute('data-position-id'));
        const isSelected = selectedPositions.some(p => p.id === nodeId);
        
        if (isSelected) {
            node.style.opacity = '1';
            node.style.filter = 'drop-shadow(0 0 8px #3b82f6)';
        } else if (selectedPositions.length > 0) {
            node.style.opacity = '0.6';
            node.style.filter = 'none';
        } else {
            node.style.opacity = '1';
            node.style.filter = 'none';
        }
    });
    
    // Actualizar panel de propiedades
    if (selectedPosition) {
        // Cambiar automáticamente a la pestaña de propiedades
        showTab('properties');
        
        document.getElementById('noSelection').classList.add('hidden');
        document.getElementById('positionProperties').classList.remove('hidden');
        
        document.getElementById('propTitle').value = selectedPosition.title;
        document.getElementById('propDepartment').value = selectedPosition.department;
        document.getElementById('propX').value = Math.round(selectedPosition.x);
        document.getElementById('propY').value = Math.round(selectedPosition.y);
    } else {
        document.getElementById('noSelection').classList.remove('hidden');
        document.getElementById('positionProperties').classList.add('hidden');
    }
    
    // Actualizar status con selección múltiple
    if (selectedPositions.length > 1) {
        showStatus(`${selectedPositions.length} posiciones seleccionadas`);
    }
}

// Funciones de control
function changeMode() {
    editorMode = document.getElementById('editorMode').value;
    const canvas = document.getElementById('organigramCanvas');
    
    switch(editorMode) {
        case 'select':
            canvas.style.cursor = 'default';
            showStatus('Modo selección - Click para seleccionar posiciones');
            break;
        case 'connect':
            canvas.style.cursor = 'crosshair';
            showStatus('Modo conexión - Click en dos posiciones para conectarlas');
            connectionStart = null;
            break;
        case 'add':
            canvas.style.cursor = 'copy';
            showStatus('Modo agregar - Click en el canvas para agregar posición');
            break;
        case 'multi':
            canvas.style.cursor = 'crosshair';
            showStatus('Modo selección múltiple - Ctrl+Click para seleccionar varias posiciones');
            break;
        case 'pan':
            canvas.style.cursor = 'grab';
            showStatus('Modo navegación - Arrastra para navegar por el organigrama');
            break;
    }
}

function toggleGrid() {
    gridEnabled = !gridEnabled;
    const grid = document.getElementById('gridBackground');
    const majorGrid = document.getElementById('majorGrid');
    const button = document.getElementById('gridToggle');
    
    if (gridEnabled) {
        grid.style.opacity = '1';
        majorGrid.style.opacity = '1';
        button.classList.add('bg-green-200', 'text-green-800');
        button.classList.remove('bg-gray-200', 'text-gray-700');
        showStatus('Grid activado - Cuadrícula visible');
    } else {
        grid.style.opacity = '0.3';
        majorGrid.style.opacity = '0.3';
        button.classList.remove('bg-green-200', 'text-green-800');
        button.classList.add('bg-gray-200', 'text-gray-700');
        showStatus('Grid desactivado - Cuadrícula tenue');
    }
}

function toggleSnap() {
    snapEnabled = !snapEnabled;
    const button = document.getElementById('snapToggle');
    
    if (snapEnabled) {
        button.classList.add('bg-green-200', 'text-green-800');
        button.classList.remove('bg-gray-200', 'text-gray-700');
        showStatus('Snap activado - Las posiciones se ajustarán a la grilla');
    } else {
        button.classList.remove('bg-green-200', 'text-green-800');
        button.classList.add('bg-gray-200', 'text-gray-700');
        showStatus('Snap desactivado');
    }
}

// Funciones de zoom
function zoomIn() {
    currentZoom = Math.min(currentZoom * 1.2, 3);
    updateZoom();
}

function zoomOut() {
    currentZoom = Math.max(currentZoom / 1.2, 0.3);
    updateZoom();
}

function resetZoom() {
    currentZoom = 1;
    updateZoom();
}

function updateZoom() {
    const canvas = document.getElementById('organigramCanvas');
    const gridBackground = document.getElementById('gridBackground');
    const majorGrid = document.getElementById('majorGrid');
    
    canvas.style.transform = `scale(${currentZoom})`;
    canvas.style.transformOrigin = 'top left';
    
    // Actualizar grid con el zoom manteniendo el tamaño del canvas
    const gridSize = Math.round(25 * currentZoom);
    const majorGridSize = Math.round(100 * currentZoom);
    
    gridBackground.style.backgroundSize = `${gridSize}px ${gridSize}px`;
    majorGrid.style.backgroundSize = `${majorGridSize}px ${majorGridSize}px`;
    
    // Actualizar displays de zoom
    const zoomPercent = Math.round(currentZoom * 100) + '%';
    document.getElementById('zoomLevel').textContent = zoomPercent;
    document.getElementById('zoomDisplay').textContent = zoomPercent;
    
    showStatus(`Zoom: ${zoomPercent}`);
}

// Funciones de pestañas
function showTab(tabName) {
    // Ocultar todos los paneles
    document.getElementById('positionsPanel').classList.add('hidden');
    document.getElementById('propertiesPanel').classList.add('hidden');
    
    // Resetear estilos de pestañas
    document.getElementById('positionsTab').className = 'flex-1 px-4 py-3 text-sm font-medium text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700';
    document.getElementById('propertiesTab').className = 'flex-1 px-4 py-3 text-sm font-medium text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700';
    
    // Mostrar panel seleccionado
    if (tabName === 'positions') {
        document.getElementById('positionsPanel').classList.remove('hidden');
        document.getElementById('positionsTab').className = 'flex-1 px-4 py-3 text-sm font-medium text-center border-b-2 border-green-500 text-green-600';
    } else if (tabName === 'properties') {
        document.getElementById('propertiesPanel').classList.remove('hidden');
        document.getElementById('propertiesTab').className = 'flex-1 px-4 py-3 text-sm font-medium text-center border-b-2 border-green-500 text-green-600';
    }
}

// Funciones de posiciones
function filterPositions() {
    const search = document.getElementById('positionSearch').value.toLowerCase();
    const department = document.getElementById('departmentFilter').value;
    
    // Obtener todos los elementos y ordenarlos por nivel
    const items = Array.from(document.querySelectorAll('.position-item'));
    const visibleItems = [];
    
    items.forEach(item => {
        const title = item.getAttribute('data-title');
        const dept = item.getAttribute('data-department');
        const level = parseInt(item.getAttribute('data-level'));
        
        const matchesSearch = !search || title.includes(search);
        const matchesDept = !department || dept === department;
        
        if (matchesSearch && matchesDept) {
            item.style.display = 'block';
            visibleItems.push({element: item, level: level});
        } else {
            item.style.display = 'none';
        }
    });
    
    // Reordenar elementos visibles por nivel jerárquico
    visibleItems.sort((a, b) => a.level - b.level);
    const container = document.getElementById('positionsList');
    
    // Reordenar en el DOM
    visibleItems.forEach(({element}) => {
        container.appendChild(element);
    });
}

function removeMultiplePositions() {
    if (selectedPositions.length === 0) return;
    
    if (confirm(`¿Remover ${selectedPositions.length} posiciones del organigrama?`)) {
        const positionIds = selectedPositions.map(p => p.id);
        
        // Remover posiciones
        positions = positions.filter(p => !positionIds.includes(p.id));
        connections = connections.filter(c => 
            !positionIds.includes(c.from) && !positionIds.includes(c.to)
        );
        
        selectedPositions = [];
        selectedPosition = null;
        saveState();
        renderChart();
        selectPosition(null);
        showStatus(`${positionIds.length} posiciones removidas`);
    }
}

function selectAllPositions() {
    selectedPositions = [...positions];
    selectedPosition = positions[0] || null;
    selectPosition(selectedPosition);
    showStatus(`Todas las posiciones seleccionadas (${positions.length})`);
}

function addPositionToChart(positionId) {
    // Verificar si ya está en el organigrama
    if (positions.find(p => p.id === positionId)) {
        showStatus('Esta posición ya está en el organigrama');
        return;
    }
    
    // Si no hay posiciones, mostrar asistente
    if (positions.length === 0) {
        showCreationWizard();
        return;
    }
    
    saveState(); // Para undo
    
    // Calcular posición automática alineada a la cuadrícula
    const x = 100 + (positions.length % 4) * 225; // Múltiplo de 25
    const y = 100 + Math.floor(positions.length / 4) * 125; // Múltiplo de 25
    
    addPositionToChartAtLocation(positionId, x, y);
}

function removeSelectedPosition() {
    if (!selectedPosition) {
        showStatus('No hay posición seleccionada');
        return;
    }
    
    if (confirm(`¿Remover "${selectedPosition.title}" del organigrama?`)) {
        saveState(); // Para undo
        showStatus('Removiendo posición...');
        
        fetch(`/organizational/api/departmental/{{ chart.id }}/remove-position/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                position_id: selectedPosition.id
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                positions = positions.filter(p => p.id !== selectedPosition.id);
                connections = connections.filter(c => c.from !== selectedPosition.id && c.to !== selectedPosition.id);
                selectedPosition = null;
                renderChart();
                selectPosition(null);
                updateUndoRedoButtons();
                showStatus(data.message);
            } else {
                showStatus('Error: ' + data.error);
            }
        })
        .catch(error => {
            showStatus('Error de conexión');
            console.error('Error:', error);
        });
    }
}

function updatePositionCoords() {
    if (!selectedPosition) return;
    
    const newX = parseInt(document.getElementById('propX').value);
    const newY = parseInt(document.getElementById('propY').value);
    
    const posIndex = positions.findIndex(p => p.id === selectedPosition.id);
    if (posIndex !== -1) {
        positions[posIndex].x = newX;
        positions[posIndex].y = newY;
        selectedPosition.x = newX;
        selectedPosition.y = newY;
        renderChart();
    }
}

// Funciones de layout automático
function autoLayout() {
    if (positions.length === 0) {
        showStatus('No hay posiciones para organizar');
        return;
    }
    
    showStatus('Aplicando layout jerárquico ICASA...');
    
    // Definir niveles jerárquicos de ICASA con espaciado correcto
    const hierarchyLevels = {
        1: { name: 'Director General', y: 50 },
        2: { name: 'Directores', y: 220 },
        3: { name: 'Gerentes', y: 390 },
        4: { name: 'Jefes', y: 560 },
        5: { name: 'Operadores', y: 730 },
        6: { name: 'Auxiliares', y: 900 }
    };
    
    // Agrupar posiciones por nivel
    const positionsByLevel = {};
    positions.forEach(pos => {
        const level = pos.level || 6; // Default a auxiliares si no tiene nivel
        if (!positionsByLevel[level]) positionsByLevel[level] = [];
        positionsByLevel[level].push(pos);
    });
    
    // Calcular ancho total disponible (canvas expandido) - centrado
    const canvasWidth = 2800; // Ancho expandido del canvas
    const positionWidth = 180; // Ancho de cada posición
    const minSpacing = 40; // Espaciado mínimo aumentado
    const startX = 400; // Comenzar más a la izquierda para centrar mejor
    
    // Posicionar cada nivel
    Object.keys(positionsByLevel).forEach(level => {
        const levelConfig = hierarchyLevels[level] || hierarchyLevels[6];
        const levelPositions = positionsByLevel[level];
        const posCount = levelPositions.length;
        
        if (posCount === 0) return;
        
        // Calcular espaciado para este nivel
        let spacing = Math.max(minSpacing, (canvasWidth - (posCount * positionWidth)) / (posCount + 1));
        
        // Si hay demasiadas posiciones, usar múltiples filas
        const maxPerRow = Math.floor(canvasWidth / (positionWidth + minSpacing));
        const rows = Math.ceil(posCount / maxPerRow);
        
        levelPositions.forEach((pos, index) => {
            const row = Math.floor(index / maxPerRow);
            const colInRow = index % maxPerRow;
            const positionsInThisRow = Math.min(maxPerRow, posCount - (row * maxPerRow));
            
            // Centrar las posiciones en cada fila
            const rowWidth = (positionsInThisRow * positionWidth) + ((positionsInThisRow - 1) * minSpacing);
            const centeredStartX = startX + (canvasWidth - rowWidth) / 4; // Ajuste para centrar mejor
            
            pos.x = centeredStartX + (colInRow * (positionWidth + minSpacing));
            pos.y = levelConfig.y + (row * 120); // 120px entre filas
        });
    });
    
    // Generar conexiones automáticas basadas en jerarquía real
    connections = [];
    
    // Crear conexiones jerárquicas basadas en reports_to real
    positions.forEach(pos => {
        if (pos.reports_to) {
            const boss = positions.find(p => p.id === pos.reports_to);
            if (boss) {
                connections.push({
                    from: boss.id,
                    to: pos.id,
                    type: 'hierarchy'
                });
            }
        }
    });
    
    // Guardar estado después del auto layout
    saveState();
    
    renderChart();
    showStatus(`Layout jerárquico aplicado - ${Object.keys(positionsByLevel).length} niveles organizados`);
    
    // Mostrar resumen por nivel
    setTimeout(() => {
        let summary = 'Distribución: ';
        Object.keys(positionsByLevel).sort().forEach(level => {
            const count = positionsByLevel[level].length;
            const levelName = hierarchyLevels[level]?.name || `Nivel ${level}`;
            summary += `${levelName}: ${count}, `;
        });
        showStatus(summary.slice(0, -2)); // Remover última coma
    }, 3000);
}

// Funciones de guardado y exportación
function saveChart() {
    document.getElementById('loadingOverlay').classList.remove('hidden');
    
    const chartData = {
        positions: positions.map(p => ({
            position_id: p.id,
            x: p.x,
            y: p.y
        })),
        connections: connections
    };
    
    fetch(`/organizational/api/departmental/{{ chart.id }}/save-positions/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(chartData)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingOverlay').classList.add('hidden');
        
        if (data.success) {
            showStatus('✅ ' + data.message);
        } else {
            showStatus('❌ Error: ' + data.error);
        }
    })
    .catch(error => {
        document.getElementById('loadingOverlay').classList.add('hidden');
        showStatus('❌ Error de conexión');
        console.error('Error:', error);
    });
}

// Funciones de exportación y nuevas herramientas
function toggleExportMenu() {
    const menu = document.getElementById('exportMenu');
    menu.classList.toggle('hidden');
}

function exportToPNG() {
    const canvas = document.getElementById('organigramCanvas');
    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(canvas);
    
    const canvas2d = document.createElement('canvas');
    const ctx = canvas2d.getContext('2d');
    const img = new Image();
    
    img.onload = function() {
        canvas2d.width = img.width;
        canvas2d.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        const link = document.createElement('a');
        link.download = `organigrama-${new Date().getTime()}.png`;
        link.href = canvas2d.toDataURL();
        link.click();
    };
    
    img.src = 'data:image/svg+xml;base64,' + btoa(svgString);
    document.getElementById('exportMenu').classList.add('hidden');
    showStatus('Exportando a PNG...');
}

function exportToPDF() {
    showStatus('Exportación PDF en desarrollo');
    document.getElementById('exportMenu').classList.add('hidden');
}

function exportToSVG() {
    const canvas = document.getElementById('organigramCanvas');
    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(canvas);
    
    const blob = new Blob([svgString], {type: 'image/svg+xml'});
    const link = document.createElement('a');
    link.download = `organigrama-${new Date().getTime()}.svg`;
    link.href = URL.createObjectURL(blob);
    link.click();
    
    document.getElementById('exportMenu').classList.add('hidden');
    showStatus('Organigrama exportado como SVG');
}

function printChart() {
    window.print();
    document.getElementById('exportMenu').classList.add('hidden');
}



// Sistema de Historial de Pasos
function saveState() {
    const state = {
        positions: JSON.parse(JSON.stringify(positions)),
        connections: JSON.parse(JSON.stringify(connections)),
        timestamp: new Date().toISOString()
    };
    
    // Si estamos en medio del historial, eliminar estados futuros
    if (currentHistoryIndex < historyStack.length - 1) {
        historyStack = historyStack.slice(0, currentHistoryIndex + 1);
    }
    
    historyStack.push(state);
    currentHistoryIndex = historyStack.length - 1;
    
    // Limitar tamaño del historial
    if (historyStack.length > maxHistorySteps) {
        historyStack.shift();
        currentHistoryIndex--;
    }
    
    console.log('Estado guardado:', currentHistoryIndex, historyStack.length);
    updateNavigationButtons();
}

function stepBack() {
    console.log('stepBack llamado:', currentHistoryIndex, historyStack.length);
    if (currentHistoryIndex <= 0) {
        showStatus('No hay más pasos atrás');
        return;
    }
    
    currentHistoryIndex--;
    const previousState = historyStack[currentHistoryIndex];
    
    positions = JSON.parse(JSON.stringify(previousState.positions));
    connections = JSON.parse(JSON.stringify(previousState.connections));
    
    renderChart();
    updateNavigationButtons();
    showStatus(`Paso atrás - Estado ${currentHistoryIndex + 1}/${historyStack.length}`);
}

function stepForward() {
    console.log('stepForward llamado:', currentHistoryIndex, historyStack.length);
    if (currentHistoryIndex >= historyStack.length - 1) {
        showStatus('No hay más pasos adelante');
        return;
    }
    
    currentHistoryIndex++;
    const nextState = historyStack[currentHistoryIndex];
    
    positions = JSON.parse(JSON.stringify(nextState.positions));
    connections = JSON.parse(JSON.stringify(nextState.connections));
    
    renderChart();
    updateNavigationButtons();
    showStatus(`Paso adelante - Estado ${currentHistoryIndex + 1}/${historyStack.length}`);
}

function updateNavigationButtons() {
    const backBtn = document.getElementById('stepBackBtn');
    const forwardBtn = document.getElementById('stepForwardBtn');
    
    console.log('Actualizando botones:', currentHistoryIndex, historyStack.length);
    
    // Botón Atrás
    if (currentHistoryIndex > 0) {
        backBtn.disabled = false;
        backBtn.className = 'px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm';
    } else {
        backBtn.disabled = true;
        backBtn.className = 'px-3 py-2 bg-gray-400 text-white rounded-lg transition-colors text-sm';
    }
    
    // Botón Adelante
    if (currentHistoryIndex < historyStack.length - 1) {
        forwardBtn.disabled = false;
        forwardBtn.className = 'px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm';
    } else {
        forwardBtn.disabled = true;
        forwardBtn.className = 'px-3 py-2 bg-gray-400 text-white rounded-lg transition-colors text-sm';
    }
}

// Función para limpiar todo
function clearAll() {
    if (confirm('¿Estás seguro de que quieres eliminar todas las posiciones del organigrama?')) {
        positions = [];
        connections = [];
        selectedPosition = null;
        selectedPositions = [];
        
        saveState();
        renderChart();
        selectPosition(null);
        showStatus('Organigrama limpiado - Todas las posiciones eliminadas');
    }
}

// Modos de vista
function changeViewMode() {
    viewMode = document.getElementById('viewMode').value;
    renderChart();
    showStatus(`Vista cambiada a: ${viewMode}`);
}

// Funciones de navegación
function handlePanMove(e) {
    if (!isPanning) return;
    
    const deltaX = panStart.x - e.clientX;
    const deltaY = panStart.y - e.clientY;
    
    canvasContainer.scrollLeft += deltaX;
    canvasContainer.scrollTop += deltaY;
    
    panStart.x = e.clientX;
    panStart.y = e.clientY;
}

function centerChart() {
    if (positions.length === 0) {
        showStatus('No hay posiciones para centrar');
        return;
    }
    
    // Calcular bounding box de todas las posiciones
    let minX = Math.min(...positions.map(p => p.x));
    let maxX = Math.max(...positions.map(p => p.x + 180)); // +180 por el ancho de la caja
    let minY = Math.min(...positions.map(p => p.y));
    let maxY = Math.max(...positions.map(p => p.y + 80));  // +80 por la altura de la caja
    
    // Calcular centro del organigrama
    const orgCenterX = (minX + maxX) / 2;
    const orgCenterY = (minY + maxY) / 2;
    
    // Calcular centro del viewport
    const viewportCenterX = canvasContainer.clientWidth / 2;
    const viewportCenterY = canvasContainer.clientHeight / 2;
    
    // Calcular scroll necesario para centrar
    const scrollX = orgCenterX - viewportCenterX;
    const scrollY = orgCenterY - viewportCenterY;
    
    // Aplicar scroll suave
    canvasContainer.scrollTo({
        left: Math.max(0, scrollX),
        top: Math.max(0, scrollY),
        behavior: 'smooth'
    });
    
    showStatus('Organigrama centrado');
}

// Funciones de conexión
function handleConnectionClick(position) {
    if (!connectionStart) {
        connectionStart = position;
        showStatus(`Conexión iniciada desde "${position.title}". Click en otra posición para conectar.`);
    } else {
        if (connectionStart.id !== position.id) {
            // Crear conexión
            const newConnection = {
                from: connectionStart.id,
                to: position.id,
                type: 'manual'
            };
            
            // Verificar si ya existe
            const exists = connections.find(c => 
                (c.from === newConnection.from && c.to === newConnection.to) ||
                (c.from === newConnection.to && c.to === newConnection.from)
            );
            
            if (!exists) {
                saveState();
                connections.push(newConnection);
                renderChart();
                showStatus(`Conexión creada entre "${connectionStart.title}" y "${position.title}"`);
            } else {
                showStatus('Ya existe una conexión entre estas posiciones');
            }
        } else {
            showStatus('No puedes conectar una posición consigo misma');
        }
        connectionStart = null;
    }
}

// Función para agregar posición en ubicación específica
function addPositionAtLocation(e) {
    const rect = e.target.getBoundingClientRect();
    const x = (e.clientX - rect.left) / currentZoom;
    const y = (e.clientY - rect.top) / currentZoom;
    
    // Mostrar modal simple para seleccionar posición
    const availablePositions = document.querySelectorAll('.position-item[style*="block"], .position-item:not([style*="none"])');
    if (availablePositions.length > 0) {
        const firstAvailable = availablePositions[0];
        const positionId = firstAvailable.getAttribute('data-position-id');
        
        if (positionId && !positions.find(p => p.id == positionId)) {
            addPositionToChartAtLocation(positionId, x, y);
        } else {
            showStatus('No hay posiciones disponibles para agregar');
        }
    } else {
        showStatus('No hay posiciones disponibles para agregar');
    }
}

function addPositionToChartAtLocation(positionId, x, y) {
    if (positions.length > 0) {
        saveState();
    }
    
    showStatus('Agregando posición...');
    
    fetch(`/organizational/api/departmental/{{ chart.id }}/add-position/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            position_id: positionId,
            x: x,
            y: y
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            positions.push(data.position);
            renderChart();
            
            // Guardar estado solo si es la primera posición o hay más de una
            if (positions.length === 1) {
                setTimeout(() => saveState(), 100);
            }
            
            updateNavigationButtons();
            showStatus(data.message);
        } else {
            showStatus('Error: ' + data.error);
        }
    })
    .catch(error => {
        showStatus('Error de conexión');
        console.error('Error:', error);
    });
}

function exportChart() {
    toggleExportMenu();
}

// Utilidades
function showStatus(message) {
    document.getElementById('statusMessage').textContent = message;
    
    // Auto-clear después de 5 segundos
    setTimeout(() => {
        if (document.getElementById('statusMessage').textContent === message) {
            document.getElementById('statusMessage').textContent = 'Listo';
        }
    }, 5000);
}

function updateStatusBar() {
    document.getElementById('positionCount').textContent = `${positions.length} posiciones`;
    document.getElementById('connectionCount').textContent = `${connections.length} conexiones`;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ===== FUNCIONES SIMPLES DEL ASISTENTE =====

function showCreationWizard() {
    document.getElementById('creationWizard').classList.remove('hidden');
    // Limpiar checkboxes
    document.querySelectorAll('#creationWizard input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    updateSelectedCount();
}

function closeCreationWizard() {
    document.getElementById('creationWizard').classList.add('hidden');
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('#creationWizard input[type="checkbox"]:checked');
    const count = checkboxes.length;
    document.getElementById('selectedCount').textContent = count;
    
    const createBtn = document.getElementById('createBtn');
    createBtn.disabled = count === 0;
}

function createSimpleOrganigram() {
    const checkboxes = document.querySelectorAll('#creationWizard input[type="checkbox"]:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        alert('Selecciona al menos una posición');
        return;
    }
    
    closeCreationWizard();
    showStatus(`Creando organigrama con ${selectedIds.length} posiciones...`);
    
    // Agregar posiciones una por una
    selectedIds.forEach((positionId, index) => {
        setTimeout(() => {
            const x = 300 + (index % 3) * 200;
            const y = 150 + Math.floor(index / 3) * 120;
            
            fetch(`/organizational/api/departmental/{{ chart.id }}/add-position/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    position_id: positionId,
                    x: x,
                    y: y
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    positions.push(data.position);
                    renderChart();
                    
                    if (index === selectedIds.length - 1) {
                        saveState();
                        showStatus('✅ Organigrama creado. Arrastra las posiciones donde quieras.');
                        editorMode = 'select';
                        document.getElementById('editorMode').value = 'select';
                        changeMode();
                    }
                } else {
                    showStatus('Error: ' + data.error);
                }
            })
            .catch(error => {
                showStatus('Error de conexión');
                console.error('Error:', error);
            });
        }, index * 300);
    });
}
</script>
{% endblock %}